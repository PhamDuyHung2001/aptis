<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/564/564500.png">

    <title>MPU6050 Target Pro</title>

    <style>
        :root {
            --primary-color: #960018;
            --accent-color: #00e676;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            position: absolute;
            top: 20px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #btn {
            padding: 10px 25px;
            font-size: 14px;
            font-weight: bold;
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-transform: uppercase;
        }

        #btn:disabled { background: #333; color: #777; box-shadow: none; }
        #status { margin-top: 8px; font-size: 11px; letter-spacing: 1px; color: var(--accent-color); }

        .target-area {
            position: relative;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, #1e1e1e 20%, #151515 100%);
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.1);
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .ring-1 { width: 75%; height: 75%; }
        .ring-2 { width: 50%; height: 50%; }
        .ring-3 { width: 25%; height: 25%; border-color: rgba(0, 210, 255, 0.2); }

        .axis-h { position: absolute; width: 100%; height: 1px; background: rgba(255,255,255,0.1); }
        .axis-v { position: absolute; width: 1px; height: 100%; background: rgba(255,255,255,0.1); }

        #pointer {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--primary-color);
            transition: transform 0.05s linear; /* Giảm thời gian để phản hồi tức thì hơn */
            z-index: 10;
        }
        #pointer::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            border: 1px solid var(--primary-color);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .data-container {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 40px;
        }

        .data-item { text-align: center; }
        .data-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        .data-value { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .error { color: #ff5252 !important; }
    </style>
</head>
<body>

<div class="header">
    <button id="btn" onclick="startConnect()">Kết nối ESP32</button>
    <div id="status">SẴN SÀNG</div>
</div>

<div class="target-area">
    <div class="ring ring-1"></div>
    <div class="ring ring-2 :border-color: var(--primary-color)"></div>
    <div class="ring ring-3"></div>
    <div class="axis-h"></div>
    <div class="axis-v"></div>

    <div id="pointer"></div>
</div>

<div class="data-container">
    <div class="data-item">
        <div class="data-label">Trục X (Roll)</div>
        <div id="x-val" class="data-value">0.0°</div>
    </div>
    <div class="data-item">
        <div class="data-label">Trục Y (Pitch)</div>
        <div id="z-val" class="data-value">0.0°</div>
    </div>
</div>

<script>
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
let myDevice = null;
const pointer = document.getElementById('pointer');

async function startConnect() {
    const status = document.getElementById('status');
    try {
        if (!navigator.bluetooth) throw new Error("Trình duyệt không hỗ trợ Bluetooth");
        status.innerText = "ĐANG QUÉT...";
        myDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [SERVICE_UUID]
        });
        myDevice.addEventListener('gattserverdisconnected', onDisconnected);
        await doConnect();
    } catch (err) {
        status.innerText = "LỖI: " + err.message;
        status.className = "error";
    }
}

async function doConnect() {
    const status = document.getElementById('status');
    const btn = document.getElementById('btn');
    try {
        status.innerText = "ĐANG KẾT NỐI...";
        const server = await myDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        const char = await service.getCharacteristic(CHAR_UUID);

        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (e) => {
            const rawData = new TextDecoder().decode(e.target.value);
            const parts = rawData.split(',');
            if (parts.length >= 2) {
                const x = parseFloat(parts[0]);
                const y = parseFloat(parts[1]);
                updateUI(x, y);
            }
        });

        status.innerText = "ONLINE";
        btn.disabled = true;
        btn.innerText = "CONNECTED";
    } catch (e) {
        status.innerText = "THỬ LẠI...";
        setTimeout(doConnect, 2000);
    }
}

function updateUI(val1, val2) {
    // Cập nhật số liệu hiển thị
    document.getElementById('x-val').innerText = val1.toFixed(1) + "°";
    document.getElementById('z-val').innerText = val2.toFixed(1) + "°";

    // --- TĂNG ĐỘ NHẠY Ở ĐÂY ---
    // limit = 5 nghĩa là chỉ cần nghiêng 5 độ là chấm tròn chạm rìa bia
    const limit = 5;

    // Tính toán tọa độ (Radius = 150px)
    // val2 (Trục Y/Z từ ESP32) điều khiển ngang
    // val1 (Trục X từ ESP32) điều khiển dọc
    let moveX = (val2 / limit) * 150;
    let moveY = (val1 / limit) * -150;

    // Giới hạn để không trôi mất khỏi vùng nhìn thấy
    moveX = Math.max(-145, Math.min(145, moveX));
    moveY = Math.max(-145, Math.min(145, moveY));

    pointer.style.transform = `translate(${moveX}px, ${moveY}px)`;
}

function onDisconnected() {
    document.getElementById('status').innerText = "OFFLINE - RECONNECTING...";
    document.getElementById('status').className = "error";
    doConnect();
}
</script>

</body>
</html>
